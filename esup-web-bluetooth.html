<!-- Bluetooth service: 6e400001-b5a3-f393-e0a9-e50e24dcca9e -->
<!-- write characteristic: 6e400002-b5a3-f393-e0a9-e50e24dcca9e -->
<!-- read service: 6e400003-b5a3-f393-e0a9-e50e24dcca9e -->
<!-- Both characteristics are 20 bytes in length, meaning transmit/receive packets longer than 20 bytes will need to be split into multiple writes or will be sent through multiple characteristic updates -->
<!-- TODO -->

<h1>PIM eSUP API</h1>
<label for="sercvice">service:</label>
<input
  type="text"
  id="service"
  name="service"
  value="6e400001-b5a3-f393-e0a9-e50e24dcca9e"
/><br /><br />
<label for="readCharacteristic">read characteristic:</label>
<input
  type="text"
  id="readCharacteristic"
  name="readCharacteristic"
  value="6e400003-b5a3-f393-e0a9-e50e24dcca9e"
/><br /><br />
<label for="writeCharacteristic">write characteristic:</label>
<input
  type="text"
  id="writeCharacteristic"
  name="writeCharacteristic"
  value="6e400002-b5a3-f393-e0a9-e50e24dcca9e"
/><br /><br />

<button type="button" id="write">Write to modbus</button>
<button type="button" id="start">Connect</button>
<button type="button" id="stop">Stop Notifications</button>
<button type="button" id="end">Disconnect</button>

<p>Throttl: <span id="throttle"></span></p>
<p>Voltage: <span id="voltage"></span></p>
<p>Amps: <span id="amperage"></span></p>

<script src="https://cdn.jsdelivr.net/gh/ethereumjs/browser-builds/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script>
<script>
  
  function crc16(buffer) {
    var crc = 0xffff;
    var odd;

    for (var i = 0; i < buffer.length; i++) {
      crc = crc ^ buffer[i];

      for (var j = 0; j < 8; j++) {
        odd = crc & 0x0001;
        crc = crc >> 1;
        if (odd) {
          crc = crc ^ 0xa001;
        }
      }
    }
    return crc;
  }

  var codeLength = 6;
  var address = 1; //address the slave unit address. do not modify
  var code = 3; //the function to call next.
  var dataAddress = 270; //Data Address of the first register.
  var length = 2; //total number of registers requested.

  var buf = ethereumjs.Buffer.Buffer.alloc(codeLength + 2); // add 2 crc bytes

  buf.writeUInt8(address, 0);
  buf.writeUInt8(code, 1);
  buf.writeUInt16BE(dataAddress, 2);
  buf.writeUInt16BE(length, 4);
  // add crc bytes to buffer
  buf.writeUInt16LE(crc16(buf.slice(0, -2)), codeLength);

  console.log("buffer: ");
  console.log(buf);  

  var myCharacteristic;
  var bluetoothDevice;

  //--------------write to modbus------------------

  function onWriteButtonClick() {
    console.log("Requesting Bluetooth Device...");
    navigator.bluetooth
      .requestDevice({
        filters: [{ services: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"] }],
      })
      .then((device) => {
        console.log("Connecting to GATT Server...");

        return device.gatt.connect();
      })
      .then((server) => {
        console.log("Getting Service...");
        return server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
      })
      .then((service) => {
        console.log("Getting Characteristic...");
        return service.getCharacteristic(
          "6e400002-b5a3-f393-e0a9-e50e24dcca9e"
        );
      })
      .then((characteristic) => {
        // Writing modbus data to controller.\
        const resetEnergyExpended = buf; //Uint8Array.of(1, 3, 0, 0, 0, 3, 5, 203);
        console.log("buffer:");
        console.log(resetEnergyExpended);
        return characteristic.writeValue(resetEnergyExpended);
      })
      .catch((error) => {
        console.error(error);
      });
  }

  //---------------- Notifications --------------------

  function onStartButtonClick() {
    bluetoothDevice = null;

    console.log("Requesting Bluetooth Device...");
    navigator.bluetooth
      .requestDevice({
        filters: [{ services: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"] }],
      })
      .then((device) => {
        bluetoothDevice = device;
        console.log("Connecting to GATT Server...");
        return device.gatt.connect();
      })
      .then((server) => {
        console.log("Getting Service...");
        return server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
      })
      .then((service) => {
        console.log("Getting Characteristic...");
        return service.getCharacteristic(
          "6e400003-b5a3-f393-e0a9-e50e24dcca9e"
        );
      })
      .then((characteristic) => {
        myCharacteristic = characteristic;
        return myCharacteristic.startNotifications().then((_) => {
          console.log("> Notifications started");
          myCharacteristic.addEventListener(
            "characteristicvaluechanged",
            handleNotifications
          );
        });
      })
      .catch((error) => {
        console.log("Argh! " + error);
      });
  }

  function onStopButtonClick() {
    if (myCharacteristic) {
      myCharacteristic
        .stopNotifications()
        .then((_) => {
          console.log("> Notifications stopped");
          myCharacteristic.removeEventListener(
            "characteristicvaluechanged",
            handleNotifications
          );
        })
        .catch((error) => {
          console.log("Argh! " + error);
        });
    }
  }

  function handleNotifications(event) {
    console.log("handling...");

    let value = event.target.value;
    let lengthArray = value.byteLength;

    for (let i = 0; i < lengthArray; i++) {
      console.log(`Register: ${i}, value: ${value.getUint8(i)}`);
    }
    for (let i = 3; i < lengthArray - 2; i += 2) {
      console.log(`Register: ${i}, value: ${value.getUint16(i)}`);
    }
  }

  function onDisconnectButtonClick() {
    console.log("Disconnecting from Bluetooth Device...");
    if (bluetoothDevice.gatt.connected) {
      bluetoothDevice.gatt.disconnect();
    } else {
      log("> Bluetooth Device is already disconnected");
    }
  }

  document
    .querySelector("#start")
    .addEventListener("click", onStartButtonClick);
  document.querySelector("#stop").addEventListener("click", onStopButtonClick);
  document
    .querySelector("#write")
    .addEventListener("click", onWriteButtonClick);
  document
    .querySelector("#end")
    .addEventListener("click", onDisconnectButtonClick);
</script>
